# Equinix Metal: Designing for availability with Virtual Circuits from Equinix Fabric

This brief will informally cover key concerns regarding availability when designing architectures that leverage interconnection with the Equinix Fabric. This document is not intended to be exhaustive or complete, it also seeds authority to any / other official documentation. 

This document also assumes an *unreasonable* amount of domain and operator knowledge and experience. Please contact Equinix Metal Support or your Equinix account team for additional guidance if this document is unclear.

## Summary



While the cloudy-nature of Fabric Virtual Circuits provide significant operational advantages, the additional abstractions in implementation of the product do introduce additional or specific concerns when designing availability conscious Interconnection architectures, that may be different from more traditional interconnection mediums or may be specific to the integration between Equinix Metal and Equinix Fabric

In particular, this document will focus on describing: 
- That Virtual Circuits are provisioned in a Primary / Secondary pattern (vs a hot failover in place pattern) where each Primary / Secondary path is a distinct Layer-2 space (VLAN)
- That in order to leverage the "Secondary" path of a "redundant" Virtual Circuit, the operator (customer) must design a Layer-3 mechanism to send traffic down that path.

There is supporting documentation of the configurations referenced here in the [folder adjacent to this document](configs/)


## Scenario #1 - Single Virtual Circuit

The below is a pseudo-logical series of "steps" that are use to describe the environment and infrastructure that would be relevant to this discussion. It is intended to read like a summarized change-control runbook of the environment, and is also intended to match or describe the diagram immediately below.

![](https://s3.wasabisys.com/packetrepo/http_assets/scenario_1_diagrram.PNG)

1. #### Scenario #1: Customer has configured Colocation
  - Customer has at least one cabinet with Equinix in the same [Metro](https://metal.equinix.com/developers/docs/locations/metros/) as Metal
  - Cabinet has 1x physical switch that is VLAN and Layer-3 capable
    - Some kind of traffic is generated by "colo backend servers" or other interconnection in this rack through these switches that would be destined for applications hosted in Equinix Metal
    - This switch is labelled as `colo_switch_01` on the diagram

2. #### Scenario #1: Customer has configured Metal
    - Customer has [signed up for Equinix Metal](https://metal.equinix.com/start/)
    - Customer has completed all ["Getting Started" actions](https://metal.equinix.com/developers/docs/accounts/users/)
    - Customer has [provisioned at least 2x Equinix Metal VLANs](https://metal.equinix.com/developers/docs/layer2-networking/vlans/)
        - 1x VLAN for `metal_backend_vlan_0001`
            - This VLAN will provide a Layer-2 namespace for inter-server communication between Metal instances East <-> West
            - In this document & diagram this is referenced as VLAN `101`
        - 1x VLAN for `metal_to_virtual_circuit_vlan_0001`
            - This VLAN will provide a Layer-2 namespace for inter-connection via Fabric Virtual Circuit, this will support North <-> South traffic in / out of Metal via Interconnection
            - in this document & diagram this is referenced as VLAN `111`
    - Customer has provisioned 2x or more Equinix Metal instances where
        - Both 2x (or more) instances have been placed ["Layer-2 Bonded Mode"](https://metal.equinix.com/developers/docs/layer2-networking/layer2-mode/)
        - Both 2x (or more) instances have been placed in the `metal_backend_vlan_0001` or `101` VLAN
        - The OS of the Metal instances have been configured with a private address space for East <-> Metal traffic
          - In this diagram or example `192.168.200.xxx/24`
        - 1x of the Metal instances is designated as `metal_router_01` instance
        - The Metal `metal_router_01` instance has been placed in the `metal_to_virtual_circuit_vlan_0001`  or `111` VLAN
            - The `metal_router_01` instance is now in both VLANs
        - The OS of the `metal_router_01` instance has been [configured to route / pass traffic for other hosts](https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux)
        - The OS of the `metal_router_01` instance has been configured with an IP in the private address space that will act as the Default Gateway for other Metal instances in this deployment model.
          - `192.168.200.1` in this documentation / diagram
    
3. #### Scenario #1: Customer has configured Fabric 

  - Customer has "activated" their [Fabric account](https://docs.equinix.com/en-us/Content/Interconnection/Fabric/getting-started/Fabric-getting-started.htm) and provisioned all physical infrastructure
  - The switch in [*Step 1*](https://github.com/dlotterman/metal_code_snippets/blob/main/documentation_stage/virtual_circuit_availability/equinix_metal_fabric_vcs_availability.md#scenario-1-customer-has-configured-colocation) is connected to the [Equinix Fabric via cross-connect](https://docs.equinix.com/en-us/Content/Interconnection/Fabric/Fabric-landing-main.htm) and [Fabric Ports](https://docs.equinix.com/en-us/Content/Interconnection/Fabric/ports/Fabric-port-details.htm)

  - Customer has initiated a the request of a [*"Shared Ports"*](https://metal.equinix.com/developers/docs/equinix-interconnect/interconnection-model/) connection from the [Metal Connections](https://metal.equinix.com/developers/docs/equinix-interconnect/introduction/) page
      - This virtual circuit is ordered **WITHOUT** redundancy, that is the checkbox for "Redundant Connection" is left unchecked
  - Customer has recorded the token they are presented by the Metal platform
  - Customer has completed the provisioning of the Virtual Circuit via Equinix Fabric
  - This virtual circuit is completed with the "Fabric Ports" associated with [Step 1](https://github.com/dlotterman/metal_code_snippets/blob/main/documentation_stage/virtual_circuit_availability/equinix_metal_fabric_vcs_availability.md#scenario-1-customer-has-configured-colocation) of this [scenario as the A-side](https://docs.equinix.com/en-us/Content/Interconnection/Fabric/layer-2/Fabric-layer-2-connections.htm)

4. #### Scenario #1: Customer has configured A & Z-Side of Virtual Circuit 
  - The switch associated with the [*1st Step*](https://github.com/dlotterman/metal_code_snippets/blob/main/documentation_stage/virtual_circuit_availability/equinix_metal_fabric_vcs_availability.md#scenario-1-customer-has-configured-colocation) have been configured to receive the VLAN carried by the virtual circuit as configured in the provisioned of the Virtual Circuit VLANID
  - Customer has tied the [Virtual Circuit to the Equinix Metal VLAN](https://metal.equinix.com/developers/docs/equinix-interconnect/interconnection-model/)
        - Where the Metal VLAN is the `metal_to_virtual_circuit_vlan_0001` VLAN referenced in the [*2nd Step*](https://github.com/dlotterman/metal_code_snippets/blob/main/documentation_stage/virtual_circuit_availability/equinix_metal_fabric_vcs_availability.md#scenario-1-customer-has-configured-metal)
  - Customer has configured the Metal `metal_router_01` instance and their 1x physical switch in such a way as they are informed of each others network availability, such that they will pass traffic between each other for the private networks behind them
  - The expectation is this would be done with something like BGP, but is open to customer implementation choice

5. #### Scenario #1: Customer has configured route advertisement
- **The OS of the `metal_router_01` instance has been configured with [bird](https://bird.network.cz/) (or other BGP or routing advertisement mechanism)**
    - **bird has been configured in such a way as the  `metal_router_01` instance is peering with the `colo_switch_01` switch across the virtual circuit VLAN, announcing the private networks of each side to one another**


### Scenario #1 "Life of a Packet"

When a server from the Metal *"Backend Server"* group (say `192.168.200.15`) tries to reach a *"Colo Server"* (say `192.168.100.60`):

- The destination of `192.168.100.60/24` will be out of it's local network so it will pass the traffic to the configured default gateway, in this case the `metal_router_01` instance at `192.168.200.1` over Metal VLAN `101`
- The router instance will receive the traffic and see that`192.168.200.1/24` is available in it's routing table from its routing advertisement, where `192.168.200.1/24` is available behind `169.254.254.3` via the Virtual Circuit / L2 Domain connected to Metal VLAN `111`.
- The router instance will pass the traffic in that North <-> South direction, where it is carried via the Virtual Circuit across Fabric where it is handed off the `colo_switch_01` in the Customers colocation environment, where it will follow a similar flow to the Customer's server.
- Return traffic would follow a similar flow


### Scenario #1 Availability Concerns

1. #### Availability of the Default Gateway
    - In both the Colo and Metal networks, the `backend` servers require a traditional default gateway to pass traffic via the Interconnection, in this case the `Metal_router_01` and `Colo_switch_01` 
        - As configured, `192.168.100.1` and `192.168.200.1` are both assigned to a single piece of equipment or host. If that hardware or host fails, the gateway for the backend servers will be unavailable and traffic will not cross the Interconnection. 
2. #### Availability of the Virtual Circuit
    - A *"Virtual Circuit"* is only a single path through a single chain of hardware through the integration between Equinix Metal, Fabric and the handoff from Fabric to the Customers Fabric Ports. 
        - This is entirely a single point of failure

#### Making the Default Gateway Highly Available

The most common solution for making the default gateway role highly available is to leverage the traditional *floating VIP* model, and leverage a cluster or availability tool to move the VIP (the default gateway) between routing hosts. 
- Leveraging *keepalived* to manage VIPs in Metal is well documented. It is worth noting that managing IPs with *keepalived* in side of a Metal Layer-2 VLAN is a very different set of problems than what is being solved for in most Metal+Keepalived documentation, which is the management of IPs in Metal's [managed Layer-3 network](https://metal.equinix.com/developers/docs/networking/ip-addresses/)
    - When operating inside a Metal VLAN, best practices will resemble more traditional *keepalived* administration and operation documentation the Metal branded keepalived documentation.
    - [Redhat Documentation on keepalived](https://www.redhat.com/sysadmin/keepalived-basics)
    - [Keepalived Read The Docs](https://keepalived.readthedocs.io/en/latest/case_study_failover.html)


#### Virtual Circuit Availability
Even when we add a second path, as we will in [Scenario #2](#Scenario #2 - Primary / Secondary Virtual Circuits), the second path **MUST** be in an [entirely second Metal VLAN](https://metal.equinix.com/developers/docs/equinix-interconnect/shared-ports/#connecting-vlans-to-shared-ports).

"Redundant" Virtual Circuits are named as such because when the two paths / virtual circuits are provisioned, the platform ensures they are deployed on infrastructure that will not be subject to the same or overlapping maintenance or outage windows. This means at least one path should be up even in the event of an expected or unexpected failure of one of the paths. 

Critically, this means while we may have two available paths, they are only Layer-2 paths. In order to take advantage of the redundancy provided by the second Layer-2 path, we have to configure a Layer-3 mechanism to divert or split traffic across virtual circuits depending on the intended availability characteristics, but in the simplest scenario of using the virtual circuits as *hot*/*cold* paths, then we must be able to move Layer-3 traffic from one VLAN / Virtual Circuit to another on the Metal and Colocation sides in response to various failures.




## Scenario #2 - Primary / Secondary Virtual Circuits

In order to highlight the infrastructure differences between scenario 1 & 2, we will repeat the original psuedo-logical steps with differences struck out and replaced in a "diff" like format.



![](https://s3.wasabisys.com/packetrepo/http_assets/scenario_w.PNG)



1. #### Scenario #2: Customer has configured Colocation
  - Customer has at least one cabinet with Equinix in the same [Metro](https://metal.equinix.com/developers/docs/locations/metros/) as Metal
  - ~~Cabinet has x physical switch that is VLAN and Layer-3 capable~~
  - Cabinet has **2x** physical switches that are VLAN and Layer-3 capable
    - Some kind of traffic is generated by "colo backend servers" or other interconnection in this rack through these switches that would be destined for applications hosted in Equinix Metal
    - These switches are labelled as `colo_switch_0[1-2]` on the diagram

2. #### Scenario #2: Customer has configured Metal
    - Customer has [signed up for Equinix Metal](https://metal.equinix.com/start/)
    - Customer has completed all ["Getting Started" actions](https://metal.equinix.com/developers/docs/accounts/users/)
    - ~~Customer has [provisioned at least 2x Equinix Metal VLANs]~~
    - Customer has [provisioned at least 3x Equinix Metal VLANs](https://metal.equinix.com/developers/docs/layer2-networking/vlans/)
        - 1x VLAN for `metal_backend_vlan_0001`
            - This VLAN will provide a Layer-2 namespace for inter-server communication between Metal instances East <-> West
            - In this document & diagram this is referenced as VLAN `101`, and is colored blue.
        - 1x VLAN for `metal_to_virtual_circuit_vlan_0001`
            - This VLAN will provide a Layer-2 namespace for inter-connection via the Fabric Primary Virtual Circuit, this will support North <-> South traffic in / out of Metal via Interconnection
            - in this document & diagram this is referenced as VLAN `111, and is colored orange`
        - **1x VLAN for `metal_to_virtual_circuit_vlan_0002`**
          - **This VLAN will provide a Layer-2 namespace for inter-connection via the Fabric Secondary Virtual Circuit, this will support North <-> South traffic in / out of Metal via Interconnection**
          - **in this document & diagram this is referenced as VLAN `111`, and is colored green**
    - ~~Customer has provisioned 2x or more Equinix Metal instances where~~
    - Customer has provisioned **3x** or more Equinix Metal instances where
        - ~~Both 2x (or more) instances have been placed ["Layer-2 Bonded Mode"](https://metal.equinix.com/developers/docs/layer2-networking/layer2-mode/)~~
        - All **3x** (or more) instances have been placed ["Layer-2 Bonded Mode"](https://metal.equinix.com/developers/docs/layer2-networking/layer2-mode/)
        - ~~Both 2x (or more) instances have been placed in the `metal_backend_vlan_0001` or `101` VLAN~~
        - All **3x** (or more) instances have been placed in the `metal_backend_vlan_0001` or `101` VLAN
        - The OS of the Metal instances have been configured with a private address space for East <-> Metal traffic
          - In this diagram or example `192.168.200.xxx/24`
        - ~~1x of the Metal instances is designated as `metal_router_01` instance~~
        - **2x** of the Metal instances is designated as `metal_router_0[1-2]` instances
        - ~~The Metal `metal_router_01` instance has been placed in the `metal_to_vi~~rtual_circuit_vlan_0001`  or `111` VLAN~~
        - The Metal `metal_router_0[1-2]` instances have been placed in the `metal_to_virtual_circuit_vlan_000[1-2]`  or `111` & `121` VLANs
            - ~~The `metal_router_01` instance~~ is now in both VLANs
            - The `metal_router_0[1-2]` instances are now in all three VLANs
        - ~~The OS of the `metal_router_01` instance has been [configured to route / pass traffic for other hosts](https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux)~~
        - The OS of the `metal_router_0[1-2]` instances have been [configured to route / pass traffic for other hosts](https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux)
        - ~~The OS of the `metal_router_01` instance has been configured with an IP in the private address space that will act as the Default Gateway for other Metal instances in this deployment model.~~
          - ~~`192.168.200.1` in this documentation / diagram~~
        - **The OS  of the `metal_router_0[1-2]` instances have been configured with [keepalived](#Making the Default Gateway Highly Available) (or other service / cluster availability tool)**
            - **keepalived has been configured to make the default gateway or `192.168.200.1` for the `101` hosted private network highly available across both `metal_router0[1-2]` instances**

3. #### Scenario #2: Customer has configured Fabric 

  - Customer has "activated" their [Fabric account](https://docs.equinix.com/en-us/Content/Interconnection/Fabric/getting-started/Fabric-getting-started.htm) and provisioned all physical infrastructure
  - The switches in [*Step 1*](https://github.com/dlotterman/metal_code_snippets/blob/main/documentation_stage/virtual_circuit_availability/equinix_metal_fabric_vcs_availability.md#scenario-2-customer-has-configured-colocation) is connected to the [Equinix Fabric via cross-connect](https://docs.equinix.com/en-us/Content/Interconnection/Fabric/Fabric-landing-main.htm) and [Fabric Ports](https://docs.equinix.com/en-us/Content/Interconnection/Fabric/ports/Fabric-port-details.htm)

  - Customer has initiated a the request of a [*"Shared Ports"*](https://metal.equinix.com/developers/docs/equinix-interconnect/interconnection-model/) connection from the [Metal Connections](https://metal.equinix.com/developers/docs/equinix-interconnect/introduction/) page
      - ~~This virtual circuit is ordered **WITHOUT** redundancy, that is the checkbox for "Redundant Connection" is left unchecked~~
      - **This virtual circuit is ordered WITH redundancy, that is the checkbox for "Redundant Connection" is checked**
  - Customer has recorded the token they are presented by the Metal platform
  - Customer has completed the provisioning of the Virtual Circuit via Equinix Fabric

4. #### Scenario #2: Customer has configured A & Z-Side of Virtual Circuit 
  - The switch associated with the [*1st Step*](https://github.com/dlotterman/metal_code_snippets/blob/main/documentation_stage/virtual_circuit_availability/equinix_metal_fabric_vcs_availability.md#scenario-2-customer-has-configured-colocation) have been configured to receive the VLAN carried by the virtual circuit as configured in the provisioned of the Virtual Circuit VLAN_ID, with Fabric ports receiving the A-side of the virtual circuit.
  - ~~Customer has tied the [Virtual Circuit to the Equinix Metal VLAN](https://metal.equinix.com/developers/docs/equinix-interconnect/interconnection-model/)~~
  - Customer has tied the [Virtual Circuits to the Equinix Metal VLANs](https://metal.equinix.com/developers/docs/equinix-interconnect/interconnection-model/)
  - Where the **Primary Virtual Circuit** is mapped to the Metal `metal_to_virtual_circuit_vlan_0001` VLAN referenced in the [*2nd Step*](https://github.com/dlotterman/metal_code_snippets/blob/main/documentation_stage/virtual_circuit_availability/equinix_metal_fabric_vcs_availability.md#scenario-2-customer-has-configured-metal)
  - Where the **Second Virtual Circuit** is mapped to the Metal `metal_to_virtual_circuit_vlan_0002` VLAN referenced in the [*2nd Step*](https://github.com/dlotterman/metal_code_snippets/blob/main/documentation_stage/virtual_circuit_availability/equinix_metal_fabric_vcs_availability.md#scenario-2-customer-has-configured-metal)

5. #### Scenario #2: Customer has configured route advertisement
- ~~**The OS of the `metal_router_01` instance has been configured with [bird](https://bird.network.cz/) (or other BGP or routing advertisement mechanism)**~~
  - ~~**bird has been configured in such a way as the  `metal_router_01` instance is peering with the `colo_switch_01` switch across the virtual circuit VLAN, announcing the private networks of each side to one another**~~
- **The OS of the `metal_router_0[1-2]` instances have been configured with [bird](https://bird.network.cz/) (or other BGP or routing advertisement mechanism)**
    - **bird has been configured in such a way as the  `metal_router_0[1-2]` instances are peering with the `colo_switch_0[1-2]` switches across both virtual circuit VLANs, announcing the private networks of each side to one another**

### Scenario #2 "Life of a Packet"

When a server from the *"Metal Backend Server"* group (say `192.168.200.15`) tries to reach a *"Colo Backed Server"* (say `192.168.100.60`):

- The destination of `192.168.100.60/24` will be out of it's local network so it will pass the traffic to the configured default gateway. The default gateway IP of `192.168.200.1` will be hosted by one of the two `metal_router_0[1-2]` instances depending on the state of *keepalived*
- The router instance will receive the traffic and see that`192.168.200.1/24` is available in it's routing table from its routing advertisement, where `192.168.200.1/24` is available behind `169.254.254.3` via the Virtual Circuit / L2 Domain connected to Metal VLAN `111`.
- The router instance will pass the traffic in that North <-> South direction, where it is carried via the Virtual Circuit across Fabric where it is handed off the `colo_switch_01` in the Customers colocation environment, where it will follow a similar flow to the Customer's server.
- Return traffic would follow a similar flow

### Scenario #2 Availability Concerns

In this scenario, we should be able to tolerate the failure of any individual point of failure and persist the availability of interconnection dependant services.












## Scenario #2.5 - Failed Primary / Secondary Virtual Circuits

In this scenario, a piece of equipment or software in the path of the primary Virtual Circuit has failed, reducing us to our single, secondary path or Virtual Circuit.

![](https://s3.wasabisys.com/packetrepo/http_assets/scenario3.PNG)

### Scenario #2.5 "Life of a Packet"

When a server from the  *"Metal Backend Server"* group (say `192.168.200.15`) tries to reach a *"Colo Backend Server"* (say `192.168.100.60`):

- The destination of `192.168.100.60/24` will be out of it's local network so it will pass the traffic to the configured default gateway. The default gateway IP of `192.168.200.1` will be hosted by one of the two `metal_router_0[1-2]` instances depending on the state of *keepalived*
- The router instance, having lost it's BGP session with `colo_switch[1-2]`, will identify that it's interface associated with the secondary VLAN (`metal_to_virtual_circuit_vlan_0002` or `121`) is the only path available 
- The router instance will pass the traffic in that North <-> South direction via the secondary virtual circuit or `121`, where it is carried via the Virtual Circuit across Fabric and is handed off to `colo_switch_02` in the Customers colocation environment, where it will follow a similar flow to the colo server.
- Return traffic would follow a similar flow
