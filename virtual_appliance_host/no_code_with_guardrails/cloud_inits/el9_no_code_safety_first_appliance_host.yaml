#cloud-config

# Install packages needed for Cockpit + KVM
# Add user "adminuser" and copy SSH key's from root for SSH user and lock down some root access
# Turn up firewall
# Use NFT as ssh brute force protection (fail2ban lite)
# Setup PAM faillock to protect cockpit UI and SOS console
# Enable automatic DNF updates

package_upgrade: true
package_reboot_if_required: true

datasource:
  Ec2:
    apply_full_imds_network_config: false
    strict_id: false

packages:
  - iperf3
  - tmux
  - firewalld
  - jq
  - vim
  - nc
  - git
  - dnf-automatic
  - dnf-plugins-core
  - unzip
  - virt-manager
  - libvirt-client
  - virt-install
  - libvirt
  - qemu-kvm
  - qemu-img
  - libguestfs
  - net-tools
  - wget
  - nginx
  - bind-utils
  - cockpit
  - cockpit-machines
  - cockpit-storaged
  - cockpit-podman
  - cockpit-system
  - cockpit-bridge
  - cockpit-pcp
  - cockpit-packagekit

groups:
 - cloud-users

users:
  - name: adminuser
    primary_group: cloud-users
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: [cloud-users, sudo]
    shell: /bin/bash

bootcmd:
  - systemctl stop kdump || true
  - systemctl disable kdump || true

runcmd:
  - [ systemctl, enable, --now, firewalld ]
  - [ firewall-cmd, --permanent, --zone=public, --set-target=DROP ]
  - [ firewall-cmd, --permanent, --zone=public, --add-service=ssh ]
  - [ firewall-cmd, --permanent, --zone=public, --add-service=http ]
  - [ firewall-cmd, --permanent, --zone=public, --add-port=81/tcp ]
  - [ firewall-cmd, --permanent, --zone=public, --add-port=82/tcp ]
  - [ firewall-cmd, --permanent, --zone=public, --add-service=cockpit ]
  - [ firewall-cmd, --permanent, --zone=trusted, --add-source=10.0.0.0/8 ]
  - [ firewall-cmd, --permanent, --zone=trusted, --add-source=172.16.100.0/24 ]
  - [ firewall-cmd, --permanent, --zone=trusted, --add-source=192.168.101.0/24 ]
  - [ firewall-cmd, --permanent, --zone=trusted, --add-source=172.16.253.0/24 ]
  - [ firewall-cmd, --permanent, --zone=trusted, --add-source=192.168.252.0/24 ]
  - [ firewall-cmd, --permanent, --zone=trusted, --add-source=172.16.251.0/24 ]
  - [ firewall-cmd, --permanent, --zone=trusted, --add-source=192.168.250.0/24 ]
  - [ firewall-cmd, --permanent, --zone=trusted, --add-source=172.16.249.0/24 ]
  - [ firewall-cmd, --permanent, --zone=trusted, --add-source=192.168.248.0/24 ]
  - [ firewall-cmd, --reload ]
  - [ nft, add, table, ip, SSHWATCH ]
  - [ nft, 'add chain ip SSHWATCH input { type filter hook input priority 0 ; }']
  - [ nft, 'add set ip SSHWATCH denylist { type ipv4_addr ; flags dynamic, timeout ; timeout 5m ; }']
  - [ nft, 'add rule ip SSHWATCH input tcp dport 22 ip protocol tcp ct state new, untracked limit rate over 10/minute add @denylist { ip saddr } log prefix "CLOUD-INIT MANAGED NFT dropping:"']
  - [ nft, 'add rule ip SSHWATCH input ip saddr @denylist drop']
  - [ nft, add, table, ip, SSHWATCH ]
  - [ nft, 'add chain ip SSHWATCH input { type filter hook input priority 0 ; }']
  - [ nft, 'add set ip SSHWATCH denylist { type ipv4_addr ; flags dynamic, timeout ; timeout 5m ; }']
  - [ nft, 'add rule ip SSHWATCH input tcp dport 22 ip protocol tcp ct state new, untracked limit rate over 10/minute add @denylist { ip saddr } log prefix "CLOUD-INIT MANAGED NFT dropping:"']
  - [ nft, 'add rule ip SSHWATCH input ip saddr @denylist drop']
  - [ authselect, select, minimal, with-faillock, --force ]
  - [ modprobe, 8021q ]
  - [ rsync, -av, "/root/.ssh", /home/adminuser/ ]
  - [ chown, -R, "adminuser:cloud-users", "/home/adminuser/.ssh" ]
  - [ sed, -i, -e, '/^#PermitRootLogin/s/^.*$/PermitRootLogin no/', /etc/ssh/sshd_config ]
  - [ sed, -i, -e, '/^#MaxAuthTries/s/^.*$/MaxAuthTries 5/', /etc/ssh/sshd_config ]
  - [ sed, -i, -e, '/^X11Forwarding/s/^.*$/X11Forwarding no/', /etc/ssh/sshd_config ]
  - [ systemctl, restart, sshd ]
  - [ sed, -i, -e, '/^apply_updates/s/^.*$/apply_updates = yes/', /etc/dnf/automatic.conf ]
  - [ bash, /var/tmp/metal_adminuser_mangle.sh ]
  - [ bash, /var/tmp/metal_network_mangle.sh ]
  - [ bash, /var/tmp/metal_disk_mangle.sh ]
  - [ systemctl, enable, --now, dnf-automatic.timer ]
  - [ systemctl, enable, --now, podman ]
  - [ systemctl, enable, --now, cockpit ]
  - [ systemctl, enable, --now, libvirtd ]
  - [ bash, /var/tmp/metal_libvirt_mangle.sh ]
  - [ bash, /var/tmp/metal_nginx_mangle.sh ]
  - [ bash, /var/tmp/metal_epel_mangle.sh ]
  - [ bash, /var/tmp/metal_smokeping_mangle.sh ]


write_files:
  - path: "/etc/modules-load.d/networking.conf"
    permissions: "0644"
    owner: "root:root"
    append: true
    content: |
      8021q

  - path: "/etc/dnf/dnf.conf"
    permissions: "0644"
    owner: "root:root"
    append: true
    content: |
      max_parallel_downloads=10
      fastestmirror=True

  - path: "/etc/security/faillock.conf"
    permissions: "0644"
    owner: "root:root"
    append: true
    content: |
      deny=4
      unlock_time=300
      audit
      even_deny_root
      root_unlock_time=60

  - path: /etc/crontab
    owner: root:root
    append: true
    content: |
      05 11 * * * root systemctl restart sshd
      10 11 * * * root systemctl restart cockpit.service
      15 11 * * * root systemctl restart serial-getty@ttyS1.service
      20 11 * * * root systemctl restart getty@tty1.service
    permissions: '0644'

  - path: "/var/tmp/metal_adminuser_mangle.sh"
    owner: root:root
    append: false
    content: |
      logger "running /var/tmp/metal_adminuser_mangle.sh"
      pwhash=$(sudo getent shadow root | cut -d: -f2)
      sudo usermod -p "$pwhash" adminuser
      chmod 0400 /var/tmp/metal_adminuser_mangle.sh
    permissions: '0644'

  - path: "/var/tmp/metal_epel_mangle.sh"
    owner: root:root
    append: false
    content: |
      logger "running /var/tmp/metal_epel_mangle.sh"
      dnf config-manager --set-enabled crb
      dnf install -y epel-release
      dnf update -y
      chmod 0400 /var/tmp/metal_epel_mangle.sh
    permissions: '0644'

  - path: "/var/tmp/metal_smokeping_mangle.sh"
    owner: root:root
    append: false
    content: |
      logger "running /var/tmp/metal_smokeping_mangle.sh"
      dnf -y install perl httpd httpd-devel mod_fcgid rrdtool perl-CGI-SpeedyCGI fping rrdtool-perl perl-Sys-Syslog fcgiwrap openssl-devel smokeping
      curl -s --retry 5 https://metadata.platformequinix.com/metadata -o /tmp/metadata
      METAL_PUBLIC_IP=$(jq -r '.network.addresses[] | select((.public==true) and .address_family==4) | .address' /tmp/metadata)
      METAL_PUBLIC_GW=$(jq -r '.network.addresses[] | select((.public==true) and .address_family==4) | .gateway' /tmp/metadata)
      METAL_PRIVATE_GW=$(jq -r '.network.addresses[] | select((.public==false) and .address_family==4) | .gateway' /tmp/metadata)
      METAL_ROUTER_IPS=('136.144.56.179' '145.40.125.17' '145.40.75.3' '147.75.87.3' '145.40.73.1' '145.40.113.3' '145.40.105.1' '147.28.133.1' '147.75.199.23' '136.144.55.31' '145.40.77.1' '145.40.93.77' '145.40.71.21' '145.40.109.1' '136.144.60.195' '147.75.92.5' '136.144.50.171' '145.40.87.43' '145.40.121.9' '139.178.82.17' '147.75.70.17' '147.75.66.143' '147.75.94.153' '147.75.33.169')

        # http://ec2-reachability.amazonaws.com/
      AWS_ENDPOINTS=('3.80.0.0' '68.66.113.112' '15.181.176.161' '15.181.192.183' '72.41.10.180' '15.181.98.141' '64.187.131.1' '15.181.144.146' '3.12.0.0' '18.252.0.253' '13.52.0.0' '18.236.0.0' '15.181.17.111' '15.253.0.254' '3.32.0.253' '3.96.0.0' '15.228.0.0' '3.248.0.0' '3.64.0.0' '3.8.0.0' '15.160.0.0' '13.36.0.0' '13.48.0.0' '13.245.0.253' '15.184.0.253' '3.112.0.0' '3.34.0.0' '13.208.32.253' '3.0.0.9' '3.24.0.0' '3.6.0.0' '16.162.0.253' '52.80.5.207' '52.82.0.253')

        # https://github.com/GoogleCloudPlatform/gcping/blob/main/internal/config/endpoints.go
      GCP_ENDPOINTS=('asia-east1-5tkroniexa-de.a.run.app' 'asia-east2-5tkroniexa-df.a.run.app' 'asia-northeast1-5tkroniexa-an.a.run.app' 'asia-northeast2-5tkroniexa-dt.a.run.app' 'asia-northeast3-5tkroniexa-du.a.run.app' 'asia-south1-5tkroniexa-el.a.run.app' 'asia-south2-5tkroniexa-em.a.run.app' 'asia-southeast1-5tkroniexa-as.a.run.app' 'asia-southeast2-5tkroniexa-et.a.run.app' 'australia-southeast1-5tkroniexa-ts.a.run.app' 'australia-southeast2-5tkroniexa-km.a.run.app' 'europe-central2-5tkroniexa-lm.a.run.app' 'europe-north1-5tkroniexa-lz.a.run.app' 'europe-west1-5tkroniexa-ew.a.run.app' 'europe-west2-5tkroniexa-nw.a.run.app' 'europe-west3-5tkroniexa-ey.a.run.app' 'europe-west4-5tkroniexa-ez.a.run.app' 'europe-west6-5tkroniexa-oa.a.run.app' 'northamerica-northeast1-5tkroniexa-nn.a.run.app' 'northamerica-northeast2-5tkroniexa-pd.a.run.app' 'southamerica-east1-5tkroniexa-rj.a.run.app' 'us-central1-5tkroniexa-uc.a.run.app' 'us-east1-5tkroniexa-ue.a.run.app' 'us-east4-5tkroniexa-uk.a.run.app' 'us-west1-5tkroniexa-uw.a.run.app' 'us-west2-5tkroniexa-wl.a.run.app' 'us-west3-5tkroniexa-wm.a.run.app' 'us-west4-5tkroniexa-wn.a.run.app')

        # DNS carriers + https://www.dotcom-monitor.com/blog/technical-tools/network-location-ip-addresses/
      RANDOM_ENDPOINTS=('208.67.222.222' '208.67.220.220' '1.1.1.1' '1.0.0.1' '8.8.8.8' '8.8.4.4' '139.130.4.5' '69.162.81.155' '192.199.248.75' '162.254.206.227' '207.250.234.100' '184.107.126.165' '206.71.50.230' '65.49.22.66' '23.81.0.59' '207.228.238.7')

      mkdir -p /var/cache/smokeping/images
      chown root:nginx /var/cache/smokeping/images

      mkdir -p /var/lib/smokeping/__cgi
      chown -R root:nginx /var/lib/smokeping/__cgi


      mkdir -p /var/tmp/smokeping
      chown -R root:nginx /var/tmp/smokeping

      cat > /etc/nginx/conf.d/smokeping.conf << EOL
      server {
          listen 82 default_server;
          listen [::]:82 default_server;
          server_name _;
          include /etc/nginx/default.d/*.conf;
          root /usr/share/smokeping/htdocs;
          index smokeping.cgi;

          location ~ \.cgi$ {
              fastcgi_intercept_errors on;
              root /usr/lib;
              include /etc/nginx/fastcgi_params;
              fastcgi_param SCRIPT_FILENAME /usr/share/smokeping/cgi/smokeping.fcgi;
              fastcgi_pass unix:/run/fcgiwrap/fcgiwrap-nginx.sock;
          }

          location / {
                  return 301 /smokeping.cgi;
          }
      }
      EOL

      mkdir -p /etc/smokeping/config.d/
      chown -R root:nginx /etc/smokeping
      chmod -R 0765 /etc/smokeping/config.d
      sudo cat > /etc/smokeping/config << EOL
      *** General ***

      owner    = metal_smokeping
      contact  = root@localhost
      mailhost = localhost
      cgiurl   = http://$METAL_PUBLIC_IP/smokeping/smokeping.cgi
      # specify this to get syslog logging
      syslogfacility = local0
      # each probe is now run in its own process
      # disable this to revert to the old behaviour
         # concurrentprobes = no
      imgcache = /var/cache/smokeping/images
      imgurl = ../images
      datadir = /var/tmp/smokeping
      piddir = /run/smokeping
      smokemail = /etc/smokeping/smokemail
      tmail = /etc/smokeping/tmail
      dyndir = /var/lib/smokeping/__cgi

      @include /etc/smokeping/config.d/Probes
      @include /etc/smokeping/config.d/Targets
      @include /etc/smokeping/config.d/Database
      @include /etc/smokeping/config.d/Presentation
      EOL

      sudo cat > /etc/smokeping/config.d/Database << EOL
      *** Database ***

      step = 15
      pings = 15

      # consfn mrhb steps total

      AVERAGE 0.5 1 1008
      AVERAGE 0.5 12 4320
      MIN 0.5 12 4320
      MAX 0.5 12 4320
      AVERAGE 0.5 144 720
      MAX 0.5 144 720
      MIN 0.5 144 720
      EOL

      sudo cat > /etc/smokeping/config.d/Presentation << EOL
      *** Presentation ***

      template = /etc/smokeping/basepage.html
      charset = utf-8
      htmltitle = yes
      graphborders = no

      + charts

      menu = Charts
      title = The most interesting destinations

      ++ stddev
      sorter = StdDev(entries=>4)
      title = Top Standard Deviation
      menu = Std Deviation
      format = Standard Deviation %f

      ++
      max
      sorter = Max(entries=>5)
      title = Top Max Roundtrip Time
      menu = by Max
      format = Max Roundtrip Time %f seconds

      ++ loss
      sorter = Loss(entries=>5)
      title = Top Packet Loss
      menu = Loss
      format = Packets Lost %f

      ++ median
      sorter = Median(entries=>5)
      title = Top Median Roundtrip Time
      menu = by Median
      format = Median RTT %f seconds

      + overview

      width = 1000
      height = 50
      range = 10h

      + detail

      width = 1000
      height = 200
      unison_tolerance = 2

      "Last 3 Hours" 3h
      "Last 30 Hours" 30h
      "Last 10 Days" 10d
      "Last 360 Days" 360d
      EOL

      sudo cat > /etc/smokeping/config.d/Probes << EOL
      *** Probes ***

      + FPing

      binary = /sbin/fping

      +Curl

      binary = /usr/bin/curl
      forks = 5
      offset = 50%
      step = 300
      follow_redirects = yes
      include_redirects = yes
      insecure_ssl = 1
      pings = 5
      timeout = 20
      urlformat = http://%host%/
      EOL
      sudo cat > /tmp/smokeping_targets_gw << EOL
      *** Targets ***
      probe = FPing
      menu = Top
      title = Metal Network Latency Grapher
      remark = Welcome to this Metal Smokeping Instance


      + local_gateways
      menu = local_gateways
      title = local_gateways

      ++ public_gateway
      probe = FPing
      host = $METAL_PUBLIC_GW
      title = public_gateway

      ++ private_gateway
      probe = FPing
      host = $METAL_PRIVATE_GW
      title = private_gateway
      EOL
      echo "+ global_metal_routers" >> /tmp/smokeping_targets_gw
      echo "menu = global_metal_routers" >> /tmp/smokeping_targets_gw
      echo "title = global_metal_routers" >> /tmp/smokeping_targets_gw
      for ROUTER in "${METAL_ROUTER_IPS[@]}"; do
          echo "++ $(echo "$ROUTER" | tr -d ".")" >> /tmp/smokeping_targets_gw
          echo "probe = FPing" >> /tmp/smokeping_targets_gw
          echo "host = $ROUTER" >> /tmp/smokeping_targets_gw
          echo "title = metal_router_$(echo $ROUTER | tr -d ".")" >> /tmp/smokeping_targets_gw
      done

      echo "+ global_aws_endpoints" >> /tmp/smokeping_targets_gw
      echo "menu = global_aws_endpoints" >> /tmp/smokeping_targets_gw
      echo "title = global_aws_endpoints" >> /tmp/smokeping_targets_gw
      for ENDPOINT in "${AWS_ENDPOINTS[@]}"; do
          echo "++ $(echo "$ENDPOINT" | tr -d ".")" >> /tmp/smokeping_targets_gw
          echo "probe = FPing" >> /tmp/smokeping_targets_gw
          echo "host = $ENDPOINT" >> /tmp/smokeping_targets_gw
          echo "title = aws_endpoint_$(echo $ENDPOINT | tr -d ".")" >> /tmp/smokeping_targets_gw
      done

      echo "+ global_gcp_endpoints" >> /tmp/smokeping_targets_gw
      echo "menu = global_gcp_endpoints" >> /tmp/smokeping_targets_gw
      echo "title = global_gcp_endpoints" >> /tmp/smokeping_targets_gw
      for ENDPOINT in "${GCP_ENDPOINTS[@]}"; do
        echo "++ $(echo $ENDPOINT | tr -d ".")" >> /tmp/smokeping_targets_gw
        echo "probe = Curl" >> /tmp/smokeping_targets_gw
        echo "host = $ENDPOINT" >> /tmp/smokeping_targets_gw
        echo "title = gcp_endpoint_$(echo $ENDPOINT | tr -d ".")" >> /tmp/smokeping_targets_gw
      done
      echo "+ random_endpoints" >> /tmp/smokeping_targets_gw
      echo "menu = random_endpoints" >> /tmp/smokeping_targets_gw
      echo "title = random_endpoints" >> /tmp/smokeping_targets_gw
      for ENDPOINT in "${RANDOM_ENDPOINTS[@]}"; do
        echo "++ $(echo "$ENDPOINT" | tr -d ".")" >> /tmp/smokeping_targets_gw
        echo "probe = FPing" >> /tmp/smokeping_targets_gw
        echo "host = $ENDPOINT" >> /tmp/smokeping_targets_gw
        echo "title = random_endpoint_$(echo $ENDPOINT | tr -d ".")" >> /tmp/smokeping_targets_gw
      done

      sudo cp -f /tmp/smokeping_targets_gw /etc/smokeping/config.d/Targets
      chown -R root:nginx /etc/smokeping/config.d/Probes
      chown -R root:nginx /etc/smokeping/config.d/Targets
      chown -R root:nginx /etc/smokeping/config.d/Database
      chown -R root:nginx /etc/smokeping/config.d/Presentation
      chown -R root:nginx /etc/smokeping/config.d/pathnames

      systemctl stop smokeping
      systemctl enable --now smokeping

      chmod 0400 /var/tmp/metal_smokeping_mangle.sh
    permissions: '0644'

  - path: "/var/tmp/metal_nginx_mangle.sh"
    owner: root:root
    append: false
    content: |
      logger "running /var/tmp/metal_nginx_mangle.sh"
      curl -s https://metadata.platformequinix.com/metadata -o /tmp/metadata
      HOST_IP=$(hostname | awk -F "-" '{print$NF}' | sed 's/^0*//')
      PRI_IP=$(jq -r '.network.addresses[] | select((.public==false) and .address_family==4) | .address' /tmp/metadata)
      cp -r /usr/share/nginx/html /usr/share/nginx/private_html
      mkdir /usr/share/nginx/private_html/autoindex
      rm /usr/share/nginx/private_html/index.html
      echo "private network" > /usr/share/nginx/private_html/index.html
      echo "private network" > /usr/share/nginx/private_html/autoindex/index.html
      cat > /etc/nginx/conf.d/metalprivate.conf << EOL
        server {
            listen       $PRI_IP:81;
            listen       localhost:81;
            listen       172.16.100.$HOST_IP:81;
            listen       192.168.101.$HOST_IP:81;
            listen       172.16.253.$HOST_IP:81;
            listen       192.168.252.$HOST_IP:81;
            listen       172.16.251.$HOST_IP:81;
            listen       192.168.250.$HOST_IP:81;
            listen       172.16.249.$HOST_IP:81;
            listen       192.168.248.$HOST_IP:81;
            server_name  _;
            root         /usr/share/nginx/private_html;

            # Load configuration files for the default server block.
            include /etc/nginx/default.d/*.conf;

            error_page 404 /404.html;
            location = /404.html {
            }

            error_page 500 502 503 504 /50x.html;
            location = /50x.html {
            }
            location = /autoindex {
                index index.html;
                autoindex on;
            }
        }
      EOL
      systemctl enable --now fcgiwrap@nginx.socket
      systemctl enable --now nginx
      systemctl restart nginx
      chmod 0400 /var/tmp/metal_nginx_mangle.sh
    permissions: '0644'

  - path: "/var/tmp/metal_libvirt_mangle.sh"
    owner: root:root
    append: false
    content: |
      logger "running /var/tmp/metal_libvirt_mangle.sh"
      curl -s https://metadata.platformequinix.com/metadata -o /tmp/metadata
      HOST_IP=$(hostname | awk -F "-" '{print$NF}' | sed 's/^0*//')
      cat > /var/tmp/metal_libvirt_network_dnsmasq.xml << EOL
        <network xmlns:dnsmasq='http://libvirt.org/schemas/network/dnsmasq/1.0'>
          <name>default</name>
          <uuid>38a47335-4455-4c57-8eab-73e84bc6b409</uuid>
          <forward mode='nat'>
            <nat>
              <port start='1024' end='65535'/>
            </nat>
          </forward>
          <bridge name='virbr0' stp='on' delay='0'/>
          <mac address='52:54:00:7f:45:20'/>
          <ip address='192.168.122.1' netmask='255.255.255.0'>
            <dhcp>
              <range start='192.168.122.2' end='192.168.122.254'/>
            </dhcp>
          </ip>
          <dnsmasq:options>
            <dnsmasq:option value='listen-address=::1,192.168.122.1,172.16.100.$HOST_IP,172.16.101.$HOST_IP'/>
            <dnsmasq:option value='server=147.75.207.207'/>
            <dnsmasq:option value='server=147.75.208.208'/>
            <dnsmasq:option value='synth-domain=libvirt.gtst.local,192.168.122.0/24,host-*'/>
            <dnsmasq:option value='synth-domain=mgmta.gtst.local,172.16.100.0/24,host-*'/>
            <dnsmasq:option value='synth-domain=mgmtb.gtst.local,172.16.101.0/24,host-*'/>
          </dnsmasq:options>
        </network>
      EOL
      virsh net-destroy default
      virsh net-undefine default
      sleep 1
      sync
      virsh net-define /var/tmp/metal_libvirt_network_dnsmasq.xml
      virsh net-start --network default
      mkdir -p /mnt/util/vms
      virsh pool-destroy default
      virsh pool-undefine default
      cat > /var/tmp/metal_storage_pool.xml << EOL
        <pool type="dir">
            <name>default</name>
            <target>
                  <path>/mnt/util/vms</path>
            </target>
        </pool>
      EOL
      virsh pool-define /var/tmp/metal_storage_pool.xml
      virsh pool-autostart default
      virsh pool-start default
      chmod 0400 /var/tmp/metal_libvirt_mangle.sh
    permissions: '0644'

  - path: "/var/tmp/metal_disk_mangle.sh"
    owner: root:root
    append: false
    content: |
      logger "running /var/tmp/metal_disk_mangle.sh"
      curl -s https://metadata.platformequinix.com/metadata -o /tmp/metadata
      mkdir /mnt/util
      PLAN=$(jq -r .plan /tmp/metadata)
      DRIVE=$(lsblk --bytes -o name,rota,type,size |  grep -v "zram" | grep -v " 1 " | grep disk | awk '{print$4,$1}' | sort -r -n  | head -1 | awk '{print$2}')
      sgdisk --zap-all /dev/$DRIVE
      mkfs.xfs -f /dev/$DRIVE
      sync
      sleep 2
      sync
      DRIVE_UUID=$(ls -al /dev/disk/by-uuid/ | grep $DRIVE | awk '{print$9}')
      cat > /etc/systemd/system/mnt-util.mount << EOL
      [Unit]
      Description=metal-mount-util-drive (/mnt/util)
      DefaultDependencies=no
      Conflicts=umount.target
      Before=local-fs.target umount.target
      After=swap.target
      [Mount]
      What=/dev/disk/by-uuid/$DRIVE_UUID
      Where=/mnt/util
      Type=xfs
      Options=defaults
      [Install]
      WantedBy=multi-user.target

      EOL

      systemctl daemon-reload
      systemctl start mnt-util.mount
      chmod 0400 /var/tmp/metal_disk_mangle.sh
    permissions: '0644'

  - path: "/var/tmp/metal_network_mangle.sh"
    owner: root:root
    append: false
    content: |
        logger "running /var/tmp/metal_network_mangle.sh"
        curl -s https://metadata.platformequinix.com/metadata -o /tmp/metadata

        NUM_INTERFACES=$(ip link list up | grep SLAVE | grep BROADCAST | wc -l)

        if [[ "$NUM_INTERFACES" == 4 ]]; then
            FIRST_INTERFACE=$(ip link list up | grep SLAVE | grep BROADCAST | grep -v "enp0s20f0u9" | awk 'NR==1' | awk '{print$2}' | tr -d "\:")
            SECOND_INTERFACE=$(ip link list up | grep SLAVE | grep BROADCAST | grep -v "enp0s20f0u9" | awk 'NR==3' | awk '{print$2}' | tr -d "\:")
        else
            FIRST_INTERFACE=$(ip link list up | grep SLAVE | grep BROADCAST | grep -v "enp0s20f0u9" | awk 'NR==1' | awk '{print$2}' | tr -d "\:")
            SECOND_INTERFACE=$(ip link list up | grep SLAVE | grep BROADCAST | grep -v "enp0s20f0u9" | awk 'NR==2' | awk '{print$2}' | tr -d "\:")
        fi


        nmcli connection delete bond0
        nmcli connection delete "System $FIRST_INTERFACE"
        nmcli connection delete "System $SECOND_INTERFACE"
        nmcli connection delete "System eth0"
        nmcli connection delete "eth0"
        rm -rf /etc/sysconfig/network-scripts/*

        PUB_IP=$(jq -r '.network.addresses[] | select((.public==true) and .address_family==4) | .address' /tmp/metadata)
        PUB_CIDR=$(jq -r '.network.addresses[] | select((.public==true) and .address_family==4) | "\/"+(.cidr|tostring)' /tmp/metadata)
        PUB_GW=$(jq -r '.network.addresses[] | select((.public==true) and .address_family==4) | .gateway' /tmp/metadata)
        PRI_IP=$(jq -r '.network.addresses[] | select((.public==false) and .address_family==4) | .address' /tmp/metadata)
        PRI_CIDR=$(jq -r '.network.addresses[] | select((.public==false) and .address_family==4) | "\/"+(.cidr|tostring)' /tmp/metadata)
        PRI_GW=$(jq -r '.network.addresses[] | select((.public==false) and .address_family==4) | .gateway' /tmp/metadata)

        HOST_IP=$(hostname | awk -F "-" '{print$NF}' | sed 's/^0*//')

        nmcli connection add type bridge ifname mbr0 con-name mbr0 ipv4.method manual ipv4.never-default true  ipv4.addresses $PUB_IP$PUB_CIDR ipv4.gateway $PUB_GW ipv4.dns '147.75.207.207,147.75.207.208'  ipv6.method ignore ipv6.never-default true 802-3-ethernet.mtu 9000 bridge.stp no

        nmcli connection modify mbr0 +ipv4.addresses $PRI_IP$PRI_CIDR
        nmcli connection modify mbr0 +ipv4.routes "$PRI_GW$PRI_CIDR $PRI_GW"
        nmcli connection modify mbr0 +ipv4.routes "10.0.0.0/8 $PRI_GW"

        nmcli connection add type bond ifname bond0 con-name bond0 bond.options  "mode=802.3ad,miimon=100,lacp_rate=slow,updelay=5000,xmit_hash_policy=layer3+4" ipv4.method disabled  ipv4.never-default true ipv6.method ignore ipv6.never-default true 802-3-ethernet.mtu 9000

        nmcli con modify bond0 master mbr0 slave-type bridge
        nmcli connection add type ethernet slave-type bond con-name bond0-port0 ifname $FIRST_INTERFACE master bond0 802-3-ethernet.mtu 9000
        nmcli connection add type ethernet slave-type bond con-name bond0-port1 ifname $SECOND_INTERFACE master bond0 802-3-ethernet.mtu 9000

        nmcli con up bond0
        sleep 2
        nmcli con up mbr0
        sleep 2

        nmcli connection add type bridge ifname mbr0.3880 con-name mbr0.3880 ipv4.method manual ipv4.never-default true ipv4.addresses 172.16.100."$HOST_IP"/24 ipv6.method ignore ipv6.never-default true 802-3-ethernet.mtu 9000 bridge.stp no
        nmcli con up mbr0.3880
        nmcli con add type vlan con-name bond0.3880 ifname bond0.3880 dev bond0 id 3880
        nmcli con modify bond0.3880 master mbr0.3880 slave-type bridge 802-3-ethernet.mtu 9000
        nmcli con up bond0.3880

        nmcli connection add type bridge ifname mbr0.3780 con-name mbr0.3780 ipv4.method manual ipv4.never-default true ipv4.addresses 192.168.101."$HOST_IP"/24 ipv6.method ignore ipv6.never-default true 802-3-ethernet.mtu 9000 bridge.stp no
        nmcli con up mbr0.3780
        nmcli con add type vlan con-name bond0.3780 ifname bond0.3780 dev bond0 id 3780
        nmcli con modify bond0.3780 master mbr0.3780 slave-type bridge 802-3-ethernet.mtu 9000
        nmcli con up bond0.3780

        nmcli connection add type bridge ifname mbr0.3870 con-name mbr0.3870 ipv4.method manual ipv4.never-default true ipv4.addresses 172.16.253."$HOST_IP"/24 ipv6.method ignore ipv6.never-default true 802-3-ethernet.mtu 9000 bridge.stp no
        nmcli con up mbr0.3870
        nmcli con add type vlan con-name bond0.3870 ifname bond0.3870 dev bond0 id 3870
        nmcli con modify bond0.3870 master mbr0.3870 slave-type bridge 802-3-ethernet.mtu 9000
        nmcli con up bond0.3870

        nmcli connection add type bridge ifname mbr0.3770 con-name mbr0.3770 ipv4.method manual ipv4.never-default true ipv4.addresses 192.168.252."$HOST_IP"/24 ipv6.method ignore ipv6.never-default true 802-3-ethernet.mtu 9000 bridge.stp no
        nmcli con up mbr0.3770
        nmcli con add type vlan con-name bond0.3770 ifname bond0.3770 dev bond0 id 3770
        nmcli con modify bond0.3770 master mbr0.3770 slave-type bridge 802-3-ethernet.mtu 9000
        nmcli con up bond0.3770

        nmcli connection add type bridge ifname mbr0.3860 con-name mbr0.3860 ipv4.method manual ipv4.never-default true ipv4.addresses 172.16.251."$HOST_IP"/24 ipv6.method ignore ipv6.never-default true 802-3-ethernet.mtu 9000 bridge.stp no
        nmcli con up mbr0.3860
        nmcli con add type vlan con-name bond0.3860 ifname bond0.3860 dev bond0 id 3860
        nmcli con modify bond0.3860 master mbr0.3860 slave-type bridge 802-3-ethernet.mtu 9000
        nmcli con up bond0.3860

        nmcli connection add type bridge ifname mbr0.3760 con-name mbr0.3760 ipv4.method manual ipv4.never-default true ipv4.addresses 192.168.250."$HOST_IP"/24 ipv6.method ignore ipv6.never-default true 802-3-ethernet.mtu 9000 bridge.stp no
        nmcli con up mbr0.3760
        nmcli con add type vlan con-name bond0.3760 ifname bond0.3760 dev bond0 id 3760
        nmcli con modify bond0.3760 master mbr0.3760 slave-type bridge 802-3-ethernet.mtu 9000
        nmcli con up bond0.3760

        nmcli connection add type bridge ifname mbr0.3850 con-name mbr0.3850 ipv4.method manual ipv4.never-default true ipv4.addresses 172.16.249."$HOST_IP"/24 ipv6.method ignore ipv6.never-default true 802-3-ethernet.mtu 9000 bridge.stp no
        nmcli con up mbr0.3850
        nmcli con add type vlan con-name bond0.3850 ifname bond0.3850 dev bond0 id 3850
        nmcli con modify bond0.3850 master mbr0.3850 slave-type bridge 802-3-ethernet.mtu 9000
        nmcli con up bond0.3850

        nmcli connection add type bridge ifname mbr0.3750 con-name mbr0.3750 ipv4.method manual ipv4.never-default true ipv4.addresses 192.168.248."$HOST_IP"/24 ipv6.method ignore ipv6.never-default true 802-3-ethernet.mtu 9000 bridge.stp no
        nmcli con up mbr0.3750
        nmcli con add type vlan con-name bond0.3750 ifname bond0.3750 dev bond0 id 3750
        nmcli con modify bond0.3750 master mbr0.3750 slave-type bridge 802-3-ethernet.mtu 9000
        nmcli con up bond0.3750

        sed -i "/net.ipv4.ip_forward=1/ s/# *//" /etc/sysctl.conf
        sed -i "/net.ipv6.conf.all.forwarding=1/ s/# *//" /etc/sysctl.conf
        sysctl -p

        if [[ "$HOST_IP" == 1 ]]; then
            nmcli con add type vlan con-name bond0.4 ifname bond0.4 dev bond0 id 4
            nmcli con modify bond0.4 master virbr0 slave-type bridge 802-3-ethernet.mtu 1500
            nmcli con up bond0.4
        fi

        chmod 0400 /var/tmp/metal_network_mangle.sh
    permissions: '0644'
